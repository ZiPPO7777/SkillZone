<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Post</title>
    <!-- Quill.js and Cropper.js styles -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #004030;
            --secondary: #000000;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --text-gray: #555555;
            --danger: #dc3545;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .form-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            padding: 30px;
        }

        h1 {
            color: var(--primary);
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--secondary);
        }

        /* Quill editor container */
        #editor-container {
            height: 200px;
            margin-bottom: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
        }

        /* Current image display */
        .current-image-container {
            margin-bottom: 20px;
            text-align: center;
        }

        .current-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 4px;
            border: 1px solid var(--medium-gray);
        }

        .current-image-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-gray);
            font-size: 14px;
        }

        /* File upload styling */
        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-upload-btn {
            border: 1px dashed var(--medium-gray);
            border-radius: 4px;
            padding: 30px;
            text-align: center;
            width: 100%;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-btn:hover {
            border-color: var(--primary);
            background-color: rgba(0, 64, 48, 0.05);
        }

        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-text {
            color: var(--text-gray);
            font-size: 14px;
            margin-top: 10px;
        }

        .file-upload-text span {
            color: var(--primary);
            font-weight: 500;
        }

        button[type="submit"] {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }

        button[type="submit"]:hover {
            background-color: #002820;
        }

        /* Hidden input for formatted HTML */
        #formatted-caption {
            display: none;
        }

        /* Image preview and cropping area */
        .image-preview-container {
            display: none;
            margin-top: 15px;
            position: relative;
        }

        #imagePreview {
            max-width: 100%;
            max-height: 400px;
            display: block;
            margin: 0 auto;
        }

        .remove-image-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .crop-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .aspect-ratio-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .aspect-ratio-btn:hover {
            border-color: var(--primary);
        }

        .aspect-ratio-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .form-container {
                padding: 20px;
            }

            h1 {
                font-size: 20px;
            }

            #imagePreview, .current-image {
                max-height: 350px;
            }
        }

        @media (max-width: 480px) {
            .form-container {
                padding: 15px;
            }

            #editor-container {
                height: 150px;
            }

            #imagePreview, .current-image {
                max-height: 300px;
            }

            .crop-controls {
                flex-direction: column;
            }

            .aspect-ratio-btn {
                width: 100%;
            }

            .remove-image-btn {
                width: 25px;
                height: 25px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>Edit Your Post</h1>
        <form method="POST" enctype="multipart/form-data" id="postForm">
            {% csrf_token %}
            <input type="hidden" name="post_id" value="{{ posts.id }}">
            
            <!-- Rich text editor for caption -->
            <div class="form-group">
                <label for="caption">Caption</label>
                <div id="editor-container">{{ post.caption|safe }}</div>
                <input type="hidden" id="formatted-caption" name="caption">
            </div>

            <!-- Current image display -->
            {% if post.image %}
            <div class="form-group current-image-container">
                <span class="current-image-label">Current Image</span>
                <img src="{{ post.image.url }}" alt="Current post image" class="current-image">
            </div>
            {% endif %}

            <!-- Image upload -->
            <div class="form-group">
                <label for="image">Change Image</label>
                <div class="file-upload">
                    <div class="file-upload-btn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" fill="var(--primary)"/>
                        </svg>
                        <p class="file-upload-text">Click to upload a new image or drag and drop<br>
                            <span>JPG, PNG (max. 5MB)</span>
                        </p>
                    </div>
                    <input type="file" id="image" name="image" class="file-upload-input" accept="image/*">
                </div>
                
                <!-- Image preview and cropping area -->
                <div class="image-preview-container">
                    <button type="button" class="remove-image-btn" id="removeImageBtn">Ã—</button>
                    <img id="imagePreview" src="#" alt="Preview">
                    <div class="crop-controls">
                        <button type="button" class="aspect-ratio-btn active" data-ratio="1">Square (1:1)</button>
                        <button type="button" class="aspect-ratio-btn" data-ratio="0.75">Portrait (3:4)</button>
                        <button type="button" class="aspect-ratio-btn" data-ratio="1.33">Landscape (4:3)</button>
                    </div>
                </div>
            </div>

            <!-- Submit button -->
            <button type="submit">Update Post</button>
        </form>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        // Initialize Quill editor
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic'],
                    ['link']
                ]
            },
            placeholder: 'Edit your post caption...'
        });

        // Before form submission, get the HTML content and put it in the hidden input
        const form = document.getElementById('postForm');
        const formattedCaptionInput = document.getElementById('formatted-caption');

        form.onsubmit = function() {
            const html = quill.root.innerHTML;
            formattedCaptionInput.value = html;
            return true;
        };

        // Image upload and cropping functionality
        const fileInput = document.querySelector('.file-upload-input');
        const fileUploadText = document.querySelector('.file-upload-text');
        const previewContainer = document.querySelector('.image-preview-container');
        const imagePreview = document.getElementById('imagePreview');
        const removeImageBtn = document.getElementById('removeImageBtn');
        let cropper;

        fileInput.addEventListener('change', function(e) {
            if (this.files && this.files.length > 0) {
                const file = this.files[0];
                fileUploadText.innerHTML = `<span>${file.name}</span>`;
                
                // Check if file is an image
                if (!file.type.match('image.*')) {
                    alert('Please select an image file');
                    return;
                }

                // Check file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size exceeds 5MB limit');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    imagePreview.src = event.target.result;
                    previewContainer.style.display = 'block';
                    
                    // Initialize cropper
                    if (cropper) {
                        cropper.destroy();
                    }
                    
                    imagePreview.onload = function() {
                        cropper = new Cropper(imagePreview, {
                            aspectRatio: 1, // Default to square
                            viewMode: 1,
                            autoCropArea: 0.8,
                            responsive: true,
                            guides: false,
                            background: false
                        });
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        // Remove image button
        removeImageBtn.addEventListener('click', function() {
            // Clear file input
            fileInput.value = '';
            // Hide preview container
            previewContainer.style.display = 'none';
            // Reset file upload text
            fileUploadText.innerHTML = 'Click to upload a new image or drag and drop<br><span>JPG, PNG (max. 5MB)</span>';
            // Destroy cropper if exists
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        });

        // Aspect ratio buttons
        const ratioButtons = document.querySelectorAll('.aspect-ratio-btn');
        ratioButtons.forEach(button => {
            button.addEventListener('click', function() {
                ratioButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                const ratio = parseFloat(this.dataset.ratio);
                if (cropper) {
                    cropper.setAspectRatio(ratio);
                }
            });
        });

        // Handle form submission to include cropped image
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent immediate submission
            
            if (cropper) {
                // Get the cropped canvas
                const canvas = cropper.getCroppedCanvas({
                    width: 1080,
                    height: 1080,
                    minWidth: 256,
                    minHeight: 256,
                    maxWidth: 4096,
                    maxHeight: 4096,
                    fillColor: '#fff',
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high',
                });

                if (canvas) {
                    // Convert canvas to blob
                    canvas.toBlob((blob) => {
                        // Create a new File from the Blob
                        const file = new File([blob], fileInput.files[0].name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });

                        // Create a new DataTransfer and add the file
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);

                        // Replace the original file input's files with the new file
                        fileInput.files = dataTransfer.files;

                        // Submit the form with the cropped image
                        const html = quill.root.innerHTML;
                        formattedCaptionInput.value = html;
                        form.submit();
                    }, 'image/jpeg', 0.9); // 0.9 is the quality (90%)
                } else {
                    // Submit without cropping if canvas is not available
                    const html = quill.root.innerHTML;
                    formattedCaptionInput.value = html;
                    form.submit();
                }
            } else {
                // Submit without any image processing
                const html = quill.root.innerHTML;
                formattedCaptionInput.value = html;
                form.submit();
            }
        });
    </script>
</body>
</html>